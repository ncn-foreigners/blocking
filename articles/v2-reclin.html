<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Blocking records for record linkage • blocking</title>
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Blocking records for record linkage">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">blocking</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v1-deduplication.html">Blocking records for deduplication</a></li>
    <li><a class="dropdown-item" href="../articles/v2-reclin.html">Blocking records for record linkage</a></li>
    <li><a class="dropdown-item" href="../articles/v3-integration.html">Integration with existing packages</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ncn-foreigners/blocking/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Blocking records for record linkage</h1>
                        <h4 data-toc-skip class="author">Maciej
Beręsewicz</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ncn-foreigners/blocking/blob/main/vignettes/v2-reclin.Rmd" class="external-link"><code>vignettes/v2-reclin.Rmd</code></a></small>
      <div class="d-none name"><code>v2-reclin.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>Read required packages</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ncn-foreigners/blocking" class="external-link">blocking</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>Read the example data from the tutorial on <a href="https://github.com/djvanderlaan/tutorial-reclin-uros2021" class="external-link">the
<code>reclin</code> package on the URos 2021 Conference</a>. The data
sets are from ESSnet on Data Integration as stated in the
repository:</p>
<pre><code>These totally fictional data sets are supposed to have captured details of
persons up to the date 31 December 2011.  Any years of birth captured as 2012
are therefore in error.  Note that in the fictional Census data set, dates of
birth between 27 March 2011 and 31 December 2011 are not necessarily in error.

census: A fictional data set to represent some observations from a
        decennial Census
cis: Fictional observations from Customer Information System, which is
        combined administrative data from the tax and benefit systems

In the dataset census all records contain a person_id. For some of the records
in cis the person_id is also available. This information can be used to
evaluate the linkage (assuming these records from the cis are representable 
all records in the cis). </code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">census</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">cis</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>
<code>census</code> object has 25343 rows and 13 columns,</li>
<li>
<code>cis</code> object has 24613 rows and 10 columns.</li>
</ul>
<p>Census data</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">census</span><span class="op">)</span></span>
<span><span class="co">#&gt;       person_id pername1 pername2    sex dob_day dob_mon dob_year hse_num</span></span>
<span><span class="co">#&gt;          &lt;char&gt;   &lt;char&gt;   &lt;char&gt; &lt;char&gt;  &lt;char&gt;  &lt;char&gt;   &lt;char&gt;   &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: DE03US001001    COUIE    PRICE      M       1       6     1960       1</span></span>
<span><span class="co">#&gt; 2: DE03US001002    ABBIE    PVICE      F       9      11     1961       1</span></span>
<span><span class="co">#&gt; 3: DE03US001003    LACEY    PRICE      F       7       2     1999       1</span></span>
<span><span class="co">#&gt; 4: DE03US001004   SAMUEL    PRICE      M      13       4     1990       1</span></span>
<span><span class="co">#&gt; 5: DE03US001005   JOSEPH    PRICE      M      20       4     1986       1</span></span>
<span><span class="co">#&gt; 6: DE03US001006     JOSH    PRICE      M      14       2     1996       1</span></span>
<span><span class="co">#&gt;           enumcap enumpc      str_nam         cap_add        census_id</span></span>
<span><span class="co">#&gt;            &lt;char&gt; &lt;char&gt;       &lt;char&gt;          &lt;char&gt;           &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 1 WINDSOR ROAD DE03US Windsor Road 1, Windsor Road CENSDE03US001001</span></span>
<span><span class="co">#&gt; 2: 1 WINDSOR ROAD DE03US Windsor Road 1, Windsor Road CENSDE03US001002</span></span>
<span><span class="co">#&gt; 3: 1 WINDSOR ROAD DE03US Windsor Road 1, Windsor Road CENSDE03US001003</span></span>
<span><span class="co">#&gt; 4: 1 WINDSOR ROAD DE03US Windsor Road 1, Windsor Road CENSDE03US001004</span></span>
<span><span class="co">#&gt; 5: 1 WINDSOR ROAD DE03US Windsor Road 1, Windsor Road CENSDE03US001005</span></span>
<span><span class="co">#&gt; 6: 1 WINDSOR ROAD DE03US Windsor Road 1, Windsor Road CENSDE03US001006</span></span></code></pre></div>
<p>CIS data</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cis</span><span class="op">)</span></span>
<span><span class="co">#&gt;        person_id pername1 pername2    sex dob_day dob_mon dob_year</span></span>
<span><span class="co">#&gt;           &lt;char&gt;   &lt;char&gt;   &lt;char&gt; &lt;char&gt;  &lt;char&gt;  &lt;char&gt;   &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: PO827ER091001   HAYDEN     HALL      M               1         </span></span>
<span><span class="co">#&gt; 2: LS992DB024001    SEREN ANDERSON      F       1       1         </span></span>
<span><span class="co">#&gt; 3:  M432ZZ053003    LEWIS    LEWIS      M       1       1         </span></span>
<span><span class="co">#&gt; 4:  SW75TQ018001 HARRISON   POSTER      M       5       1         </span></span>
<span><span class="co">#&gt; 5: EX527TR017006 MUHAMMED   WATSUN      M       7       1         </span></span>
<span><span class="co">#&gt; 6: SW540RB001001     RHYS THOMPSON      M       7       1         </span></span>
<span><span class="co">#&gt;               enumcap  enumpc           cis_id</span></span>
<span><span class="co">#&gt;                &lt;char&gt;  &lt;char&gt;           &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:   91 CLARENCE ROAD PO827ER CISPO827ER091001</span></span>
<span><span class="co">#&gt; 2:     24 CHURCH LANE LS992DB CISLS992DB024001</span></span>
<span><span class="co">#&gt; 3:     53 CHURCH ROAD  M432ZZ  CISM432ZZ053003</span></span>
<span><span class="co">#&gt; 4:  19 HIGHFIELD ROAD  SW75TG  CISSW75TQ018001</span></span>
<span><span class="co">#&gt; 5: 17 VICTORIA STREET         CISEX527TR017006</span></span>
<span><span class="co">#&gt; 6: 1 SPRINGFIELD ROAD SW540RB CISSW540RB001001</span></span></code></pre></div>
<p>We randomly select 12671 records from <code>census</code> and 12306
records from <code>cis</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2024</span><span class="op">)</span></span>
<span><span class="va">census</span> <span class="op">&lt;-</span> <span class="va">census</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">census</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">census</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">cis</span> <span class="op">&lt;-</span> <span class="va">cis</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cis</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cis</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<p>We need to create new columns that concatenate variables from
<code>pername1</code> to <code>enumpc</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">census</span><span class="op">[</span>, <span class="va">txt</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">pername1</span>, <span class="va">pername2</span>, <span class="va">sex</span>, <span class="va">dob_day</span>, <span class="va">dob_mon</span>, <span class="va">dob_year</span>, <span class="va">enumcap</span>, <span class="va">enumpc</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">cis</span><span class="op">[</span>, <span class="va">txt</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">pername1</span>, <span class="va">pername2</span>, <span class="va">sex</span>, <span class="va">dob_day</span>, <span class="va">dob_mon</span>, <span class="va">dob_year</span>, <span class="va">enumcap</span>, <span class="va">enumpc</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="linking-datasets">Linking datasets<a class="anchor" aria-label="anchor" href="#linking-datasets"></a>
</h2>
<div class="section level3">
<h3 id="using-basic-functionalities-of-blocking-package">Using basic functionalities of <code>blocking</code> package<a class="anchor" aria-label="anchor" href="#using-basic-functionalities-of-blocking-package"></a>
</h3>
<p>The goal of this exercise is to link units from the CIS dataset to
the CENSUS dataset.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/blocking.html">blocking</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">census</span><span class="op">$</span><span class="va">txt</span>, y <span class="op">=</span> <span class="va">cis</span><span class="op">$</span><span class="va">txt</span>, verbose <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; ===== creating tokens =====</span></span>
<span><span class="co">#&gt; ===== starting search (nnd, x, y: 12671, 12306, t: 1053) =====</span></span>
<span><span class="co">#&gt; ===== creating graph =====</span></span></code></pre></div>
<p>Distribution of distances for each pair.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">result1</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">dist</span>, main <span class="op">=</span> <span class="st">"Distribution of distances between pairs"</span>, xlab <span class="op">=</span> <span class="st">"Distances"</span><span class="op">)</span></span></code></pre></div>
<p><img src="v2-reclin_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Example pairs.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">result1</span><span class="op">$</span><span class="va">result</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;         x     y block       dist</span></span>
<span><span class="co">#&gt;     &lt;int&gt; &lt;int&gt; &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:     1 12088  8344 0.04520786</span></span>
<span><span class="co">#&gt;  2:     2 12156  8382 0.26164961</span></span>
<span><span class="co">#&gt;  3:     3  7243  5759 0.04604095</span></span>
<span><span class="co">#&gt;  4:     3 10643  5759 0.37306446</span></span>
<span><span class="co">#&gt;  5:     4  8422  6457 0.35876358</span></span>
<span><span class="co">#&gt;  6:     6  9442  7042 0.31899476</span></span>
<span><span class="co">#&gt;  7:     6 10195  7042 0.04166669</span></span>
<span><span class="co">#&gt;  8:     7   745   725 0.16333997</span></span>
<span><span class="co">#&gt;  9:     8  3072  2770 0.25784391</span></span>
<span><span class="co">#&gt; 10:     8 10717  2770 0.12358326</span></span></code></pre></div>
<p>Let’s take a look at the first pair. Obviously there is a typo in the
<code>pername1</code> but all the other variables are the same, so it
appears to be a match.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">census</span><span class="op">[</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cis</span><span class="op">[</span><span class="fl">12088</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]              [,2]             </span></span>
<span><span class="co">#&gt; person_id "SW122AB001001"   "SW122AB001001"  </span></span>
<span><span class="co">#&gt; pername1  "GEURGE"          "GEORGE"         </span></span>
<span><span class="co">#&gt; pername2  "HUGHES"          "HUGHES"         </span></span>
<span><span class="co">#&gt; sex       "M"               "M"              </span></span>
<span><span class="co">#&gt; dob_day   "19"              "19"             </span></span>
<span><span class="co">#&gt; dob_mon   "5"               "5"              </span></span>
<span><span class="co">#&gt; dob_year  "1942"            "1942"           </span></span>
<span><span class="co">#&gt; enumcap   "1 VICTORIA ROAD" "1 VICTORIA ROAD"</span></span>
<span><span class="co">#&gt; enumpc    "SW122AB"         "SW122AB"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="assessing-the-quality">Assessing the quality<a class="anchor" aria-label="anchor" href="#assessing-the-quality"></a>
</h3>
<p>For some records, we have information about the correct linkage. We
can use this information to evaluate our approach.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">census</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">.N</span>, <span class="va">person_id</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                 y <span class="op">=</span> <span class="va">cis</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">.N</span>, <span class="va">person_id</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                 by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span></span>
<span><span class="va">matches</span><span class="op">[</span>, <span class="va">block</span><span class="op">:=</span><span class="fl">1</span><span class="op">:</span><span class="va">.N</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">matches</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;person_id&gt;</span></span>
<span><span class="co">#&gt;       person_id     x     y block</span></span>
<span><span class="co">#&gt;          &lt;char&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1: DE03US001003  1357 10248     1</span></span>
<span><span class="co">#&gt; 2: DE03US008001  4506  2506     2</span></span>
<span><span class="co">#&gt; 3: DE03US012002  2706 12005     3</span></span>
<span><span class="co">#&gt; 4: DE03US012003  6317 11103     4</span></span>
<span><span class="co">#&gt; 5: DE03US013003  4388 10673     5</span></span>
<span><span class="co">#&gt; 6: DE03US014003  9463 11793     6</span></span></code></pre></div>
<p>So in our example we have 5991 pairs.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/blocking.html">blocking</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">census</span><span class="op">$</span><span class="va">txt</span>, y <span class="op">=</span> <span class="va">cis</span><span class="op">$</span><span class="va">txt</span>, verbose <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                    true_blocks <span class="op">=</span> <span class="va">matches</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">block</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; ===== creating tokens =====</span></span>
<span><span class="co">#&gt; ===== starting search (nnd, x, y: 12671, 12306, t: 1053) =====</span></span>
<span><span class="co">#&gt; ===== creating graph =====</span></span></code></pre></div>
<p>Let’s see how our approach handled this problem.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result2</span></span>
<span><span class="co">#&gt; ========================================================</span></span>
<span><span class="co">#&gt; Blocking based on the nnd method.</span></span>
<span><span class="co">#&gt; Number of blocks: 8441.</span></span>
<span><span class="co">#&gt; Number of columns used for blocking: 1053.</span></span>
<span><span class="co">#&gt; Reduction ratio: 0.9999.</span></span>
<span><span class="co">#&gt; ========================================================</span></span>
<span><span class="co">#&gt; Distribution of the size of the blocks:</span></span>
<span><span class="co">#&gt;    2    3    4    5    6    7    8    9 </span></span>
<span><span class="co">#&gt; 5575 2084  609  140   25    6    1    1 </span></span>
<span><span class="co">#&gt; ========================================================</span></span>
<span><span class="co">#&gt; Evaluation metrics (standard):</span></span>
<span><span class="co">#&gt;      recall   precision         fpr         fnr    accuracy specificity </span></span>
<span><span class="co">#&gt;     99.8159     99.5326      0.0001      0.1841     99.9999     99.9999 </span></span>
<span><span class="co">#&gt;    f1_score </span></span>
<span><span class="co">#&gt;     99.6740</span></span></code></pre></div>
<p>It seems that the default parameters of the NND method result in an
FNR of 0.18%. We can see if decreasing the <code>epsilon</code>
parameter as suggested in the <a href="https://jlmelville.github.io/rnndescent/articles/nearest-neighbor-descent.html" class="external-link">Nearest
Neighbor Descent</a> vignette will help.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ann_control_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/controls_ann.html">controls_ann</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ann_control_pars</span><span class="op">$</span><span class="va">nnd</span><span class="op">$</span><span class="va">epsilon</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span></span>
<span><span class="va">result3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/blocking.html">blocking</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">census</span><span class="op">$</span><span class="va">txt</span>, y <span class="op">=</span> <span class="va">cis</span><span class="op">$</span><span class="va">txt</span>, verbose <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                    true_blocks <span class="op">=</span> <span class="va">matches</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">block</span><span class="op">)</span><span class="op">]</span>, </span>
<span>                    control_ann <span class="op">=</span> <span class="va">ann_control_pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; ===== creating tokens =====</span></span>
<span><span class="co">#&gt; ===== starting search (nnd, x, y: 12671, 12306, t: 1053) =====</span></span>
<span><span class="co">#&gt; ===== creating graph =====</span></span></code></pre></div>
<p>Changing the <code>epsilon</code> search parameter from 0.1 to 0.2
decreased the FNR to 0.07%.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result3</span></span>
<span><span class="co">#&gt; ========================================================</span></span>
<span><span class="co">#&gt; Blocking based on the nnd method.</span></span>
<span><span class="co">#&gt; Number of blocks: 8448.</span></span>
<span><span class="co">#&gt; Number of columns used for blocking: 1053.</span></span>
<span><span class="co">#&gt; Reduction ratio: 0.9999.</span></span>
<span><span class="co">#&gt; ========================================================</span></span>
<span><span class="co">#&gt; Distribution of the size of the blocks:</span></span>
<span><span class="co">#&gt;    2    3    4    5    6    7    8    9 </span></span>
<span><span class="co">#&gt; 5587 2082  604  142   26    5    1    1 </span></span>
<span><span class="co">#&gt; ========================================================</span></span>
<span><span class="co">#&gt; Evaluation metrics (standard):</span></span>
<span><span class="co">#&gt;      recall   precision         fpr         fnr    accuracy specificity </span></span>
<span><span class="co">#&gt;     99.9332     99.8331      0.0000      0.0668    100.0000    100.0000 </span></span>
<span><span class="co">#&gt;    f1_score </span></span>
<span><span class="co">#&gt;     99.8831</span></span></code></pre></div>
<p>Finally, compare the NND and HNSW algorithm for this example.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/blocking.html">blocking</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">census</span><span class="op">$</span><span class="va">txt</span>, y <span class="op">=</span> <span class="va">cis</span><span class="op">$</span><span class="va">txt</span>, verbose <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                    true_blocks <span class="op">=</span> <span class="va">matches</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">block</span><span class="op">)</span><span class="op">]</span>, </span>
<span>                    ann <span class="op">=</span> <span class="st">"hnsw"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ===== creating tokens =====</span></span>
<span><span class="co">#&gt; ===== starting search (hnsw, x, y: 12671, 12306, t: 1053) =====</span></span>
<span><span class="co">#&gt; ===== creating graph =====</span></span></code></pre></div>
<p>It seems that the HNSW algorithm also performed with 0.07% FNR.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result4</span></span>
<span><span class="co">#&gt; ========================================================</span></span>
<span><span class="co">#&gt; Blocking based on the hnsw method.</span></span>
<span><span class="co">#&gt; Number of blocks: 8446.</span></span>
<span><span class="co">#&gt; Number of columns used for blocking: 1053.</span></span>
<span><span class="co">#&gt; Reduction ratio: 0.9999.</span></span>
<span><span class="co">#&gt; ========================================================</span></span>
<span><span class="co">#&gt; Distribution of the size of the blocks:</span></span>
<span><span class="co">#&gt;    2    3    4    5    6    7    8    9 </span></span>
<span><span class="co">#&gt; 5586 2078  607  142   26    5    1    1 </span></span>
<span><span class="co">#&gt; ========================================================</span></span>
<span><span class="co">#&gt; Evaluation metrics (standard):</span></span>
<span><span class="co">#&gt;      recall   precision         fpr         fnr    accuracy specificity </span></span>
<span><span class="co">#&gt;     99.9332     99.8331      0.0000      0.0668    100.0000    100.0000 </span></span>
<span><span class="co">#&gt;    f1_score </span></span>
<span><span class="co">#&gt;     99.8831</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="compare-results">Compare results<a class="anchor" aria-label="anchor" href="#compare-results"></a>
</h3>
<p>Finally, we can compare the results of two ANN algorithms. The
overlap between neighbours is given by</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"no tuning"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result2</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">x</span> <span class="op">==</span> <span class="va">result4</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span>,</span>
<span>  <span class="st">"with tuning"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result3</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">x</span> <span class="op">==</span> <span class="va">result4</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt;   no tuning with tuning </span></span>
<span><span class="co">#&gt;    98.76483    99.17926</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Maciej Beręsewicz, Adam Struzik.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
